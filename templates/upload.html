<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload CSV - Grade Insight</title>
    <link rel="stylesheet" href="/static/css/compact.css">
    <script src="/static/js/shared-utils.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Upload CSV File</h1>
            <p>Upload your grade data and organize it with tags ONLY IF YOU WANT TO</p>
        </div>

        <div class="navigation">
            <a href="www.gradeinsight.com" class="back-link">‚Üê Back to Dashboard</a>
        </div>

        <div id="messageContainer" class="message"></div>

        <form id="uploadForm" enctype="multipart/form-data">
            <div class="form-group" style="margin-bottom: 24px;">
                <label for="fileInput" style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Select CSV File</label>
                <input id="fileInput" name="file" type="file" accept=".csv" required class="search-input">
                <div id="fileInfo" style="display:none; margin-top:8px; color:#059669; font-size:14px;"></div>
            </div>
            
            <div class="form-group" style="margin-bottom: 24px;">
                <label for="teacherNameInput" style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Your Name (Teacher)</label>
                <input type="text" id="teacherNameInput" name="teacher_name" placeholder="e.g., John Doe" required class="search-input">
            </div>
            
            <div class="form-group" style="margin-bottom: 24px;">
                <label for="classTagInput" style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Class/Section Tag</label>
                <input type="text" id="classTagInput" name="class_tag" placeholder="e.g., Math-101, Fall2024" required class="search-input">
                <div style="font-size:12px; color:#64748b; margin-top:4px;">
                    This will group all grades from this upload.
                </div>
            </div>
            
            <button type="submit" id="submitBtn" class="search-btn" style="width: 100%; margin-top: 16px;">
                <span id="submitText">Upload CSV</span>
                <span id="loadingSpinner" style="display:none;">
                    <span class="loading-spinner"></span>
                    Processing...
                </span>
            </button>
        </form>

        <div id="progressSection" style="display:none; margin-top:32px;">
            <div style="background-color:#f8fafc; padding:24px; border-radius:12px; border:1px solid #e2e8f0;">
                <h3 style="color:#1e293b; margin-bottom:16px;">Upload Progress</h3>
                <div id="progressSteps">
                    <div class="progress-step" id="step1" style="margin-bottom: 8px; color: #64748b;">
                        <span style="margin-right: 8px;">üìÅ</span> Validating file...
                    </div>
                    <div class="progress-step" id="step2" style="margin-bottom: 8px; color: #64748b;">
                        <span style="margin-right: 8px;">üè∑Ô∏è</span> Processing tags...
                    </div>
                    <div class="progress-step" id="step3" style="margin-bottom: 8px; color: #64748b;">
                        <span style="margin-right: 8px;">üíæ</span> Saving data...
                    </div>
                    <div class="progress-step" id="step4" style="margin-bottom: 8px; color: #64748b;">
                        <span style="margin-right: 8px;">‚úÖ</span> Complete!
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const uploadForm = document.getElementById('uploadForm');
            const fileInput = document.getElementById('fileInput');
            const fileInfo = document.getElementById('fileInfo');
            const submitBtn = document.getElementById('submitBtn');
            const submitText = document.getElementById('submitText');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const messageContainer = document.getElementById('messageContainer');
            const progressSection = document.getElementById('progressSection');
            const teacherNameInput = document.getElementById('teacherNameInput');
            const classTagInput = document.getElementById('classTagInput');

            // Utility function to set loading state
            function setLoadingState(loading) {
                submitBtn.disabled = loading;
                submitText.style.display = loading ? 'none' : 'inline';
                loadingSpinner.style.display = loading ? 'inline-flex' : 'none';
                fileInput.disabled = loading;
                teacherNameInput.disabled = loading;
                classTagInput.disabled = loading;
            }

            // Utility function to show progress section
            function showProgress() {
                progressSection.style.display = 'block';
                // Optional: Scroll into view
                progressSection.scrollIntoView({ behavior: 'smooth' });
            }

            // Utility function to update individual progress steps
            function updateProgressStep(stepNumber, status) {
                const step = document.getElementById(`step${stepNumber}`);
                if (step) {
                    // Reset all states for the current step first to ensure clean updates
                    step.classList.remove('active', 'completed');
                    step.style.color = '#64748b'; // Default color
                    step.style.fontWeight = 'normal'; // Default font weight

                    if (status === 'active') {
                        step.classList.add('active');
                        step.style.color = '#4f46e5'; // Purple
                        step.style.fontWeight = '600';
                    } else if (status === 'complete') {
                        step.classList.add('completed');
                        step.style.color = '#059669'; // Green
                        step.style.fontWeight = '600';
                    } else if (status === 'error') {
                        step.classList.add('error'); // You might want to define this in compact.css
                        step.style.color = 'red';
                        step.style.fontWeight = '600';
                    }
                }
            }

            // Show selected file name and validate .csv extension
            fileInput.addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    if (!file.name.toLowerCase().endsWith('.csv')) {
                        GradeUtils.showNotification('messageContainer', 'Please select a CSV file.', 'error');
                        fileInfo.style.display = 'none';
                        this.value = ''; // Clear the selected file
                        return;
                    }
                    fileInfo.textContent = `Selected: ${GradeUtils.escapeHtml(file.name)} (${(file.size / 1024).toFixed(2)} KB)`;
                    fileInfo.style.display = 'block';
                    GradeUtils.showNotification('messageContainer', '', 'info'); // Clear previous messages
                } else {
                    fileInfo.style.display = 'none';
                }
            });

            uploadForm.addEventListener('submit', async function(event) {
                event.preventDefault(); // Prevent default form submission

                // Client-side validation
                if (!fileInput.files[0]) {
                    GradeUtils.showNotification('messageContainer', 'Please select a CSV file to upload.', 'error');
                    return;
                }
                if (!teacherNameInput.value.trim()) {
                    GradeUtils.showNotification('messageContainer', 'Please enter your name (Teacher).', 'error');
                    return;
                }
                if (!classTagInput.value.trim()) {
                    GradeUtils.showNotification('messageContainer', 'Please enter a Class/Section Tag.', 'error');
                    return;
                }

                setLoadingState(true);
                showProgress();
                GradeUtils.showNotification('messageContainer', '', 'info'); // Clear any previous notification

                // Reset all progress steps
                for (let i = 1; i <= 4; i++) {
                    updateProgressStep(i, 'idle'); // Set all to a neutral/idle state
                }
                updateProgressStep(1, 'active');

                const formData = new FormData(uploadForm);
                // formData.append('file', fileInput.files[0]); // Already added by new FormData(uploadForm)
                // formData.append('teacher_name', teacherNameInput.value); // Already added
                // formData.append('class_tag', classTagInput.value); // Already added

                try {
                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });

                    updateProgressStep(1, 'complete'); // File validated (implicitly if upload starts)
                    updateProgressStep(2, 'active'); // Processing tags (conceptual step)

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        const errorMessage = errorData.detail || errorData.error || `Upload failed with status ${response.status}`;
                        throw new Error(errorMessage);
                    }

                    const result = await response.json();
                    
                    updateProgressStep(2, 'complete'); // Tags processed
                    updateProgressStep(3, 'active'); // Saving data

                    // Simulate saving data delay, then complete
                    setTimeout(() => {
                        updateProgressStep(3, 'complete');
                        updateProgressStep(4, 'complete'); // All steps complete
                        GradeUtils.showNotification('messageContainer', result.message || 'CSV uploaded successfully! Redirecting to dashboard...', 'success');
                        
                        setTimeout(() => {
                            window.location.href = '/dashboard';
                        }, 2000);
                    }, 500); // Small delay for visual effect of saving
                    
                } catch (error) {
                    console.error('Upload error:', error);
                    // Determine which step to highlight as error based on where it failed, or default to last active/first if general
                    if (error.message.includes('status 422') || error.message.includes('validation')) {
                         updateProgressStep(1, 'error'); // Validation error
                    } else if (error.message.includes('failed')) {
                         updateProgressStep(3, 'error'); // Saving data error
                    } else {
                         // Fallback for network or unexpected errors
                         updateProgressStep(1, 'error');
                         updateProgressStep(2, 'idle'); // Reset subsequent steps
                         updateProgressStep(3, 'idle');
                         updateProgressStep(4, 'idle');
                    }
                    GradeUtils.showNotification('messageContainer', `Upload failed: ${GradeUtils.escapeHtml(error.message)}`, 'error');
                    hideProgress(); // Hide the progress section on error
                } finally {
                    setLoadingState(false);
                }
            });
        });
    </script>
</body>
</html>